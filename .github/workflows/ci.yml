name: CI - Container Build & Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # =============================================================================
  # Ubuntu + Docker
  # =============================================================================
  ubuntu-docker:
    name: Ubuntu + Docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install MkDocs Material
        run: pip install mkdocs-material

      - name: Build MkDocs site
        run: ./scripts/build.sh

      - name: Verify site directory
        run: |
          test -d site
          test -f site/index.html
          echo "✅ Site directory exists with index.html"

      - name: Build Docker image
        run: docker build -t mkdocs-nginx -f container/Dockerfile .

      - name: Run container
        run: |
          docker run -d \
            --name mkdocs-nginx \
            -p 8080:80 \
            -v "$(pwd)/site:/usr/share/nginx/html:ro" \
            mkdocs-nginx

      - name: Debug - Check container status
        run: |
          echo "=== Container status ==="
          docker ps -a
          echo ""
          echo "=== Container logs ==="
          docker logs mkdocs-nginx || true
          echo ""
          echo "=== Files in container ==="
          docker exec mkdocs-nginx ls -la /usr/share/nginx/html/ || true

      - name: Wait for HTTP 200 and test
        run: |
          echo "Waiting for container to be ready..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ HTTP 200 OK (attempt $i)"
              exit 0
            fi
            echo "Waiting for HTTP 200... ($i/30) got $HTTP_CODE"
            sleep 1
          done
          echo "❌ Container did not return HTTP 200 in time"
          docker logs mkdocs-nginx || true
          exit 1

      - name: Test content
        run: |
          curl -s http://localhost:8080 | grep -q "ManualServe"
          echo "✅ Content check passed"

      - name: Cleanup
        if: always()
        run: |
          docker stop mkdocs-nginx || true
          docker rm mkdocs-nginx || true

  # =============================================================================
  # AlmaLinux + Podman
  # =============================================================================
  almalinux-podman:
    name: AlmaLinux + Podman
    runs-on: ubuntu-latest

    container:
      image: almalinux:9
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y git python3 python3-pip podman runc

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MkDocs Material
        run: pip3 install mkdocs-material

      - name: Build MkDocs site
        run: ./scripts/build.sh

      - name: Verify site directory
        run: |
          test -d site
          test -f site/index.html
          echo "✅ Site directory exists with index.html"

      - name: Build Podman image
        run: podman build -t mkdocs-nginx -f container/Containerfile .

      - name: Run container
        run: |
          podman --runtime runc run -d \
            --name mkdocs-nginx \
            -p 8080:80 \
            -v "$(pwd)/site:/usr/share/nginx/html:ro" \
            mkdocs-nginx

      - name: Install curl
        run: dnf install -y curl

      - name: Wait for HTTP 200 and test
        run: |
          echo "Waiting for container to be ready..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ HTTP 200 OK (attempt $i)"
              exit 0
            fi
            echo "Waiting for HTTP 200... ($i/30) got $HTTP_CODE"
            sleep 1
          done
          echo "❌ Container did not return HTTP 200 in time"
          podman logs mkdocs-nginx || true
          exit 1

      - name: Test content
        run: |
          curl -s http://localhost:8080 | grep -q "ManualServe"
          echo "✅ Content check passed"

      - name: Cleanup
        if: always()
        run: |
          podman stop mkdocs-nginx || true
          podman rm mkdocs-nginx || true

  # =============================================================================
  # Test container-run.sh script
  # =============================================================================
  test-container-run-script:
    name: Test container-run.sh (Ubuntu)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install MkDocs Material
        run: pip install mkdocs-material

      - name: Build MkDocs site
        run: ./scripts/build.sh

      - name: Run container-run.sh script
        run: |
          chmod +x container/container-run.sh
          ./container/container-run.sh

      - name: Verify container is running
        run: |
          docker ps | grep mkdocs-nginx
          echo "✅ Container is running"

      - name: Wait for HTTP 200 and test
        run: |
          echo "Waiting for container to be ready..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ HTTP 200 OK (attempt $i)"
              exit 0
            fi
            echo "Waiting for HTTP 200... ($i/30) got $HTTP_CODE"
            sleep 1
          done
          echo "❌ Container did not return HTTP 200 in time"
          docker logs mkdocs-nginx || true
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker stop mkdocs-nginx || true
          docker rm mkdocs-nginx || true
